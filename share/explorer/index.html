<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Knotcoin</title>
  <style>
    html,
    body {
      height: 100%
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      color: #1a1a1a
    }

    .app {
      display: flex;
      height: 100vh;
      overflow: hidden
    }

    .sidebar {
      width: 190px;
      background: #0d0d0d;
      color: #bbb;
      padding: 0;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      user-select: none
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 18px 16px;
      border-bottom: 1px solid #1e1e1e
    }

    .logo-mark {
      width: 32px;
      height: 32px;
      background: #4ade80;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 18px;
      color: #000;
      flex-shrink: 0;
      letter-spacing: -1px;
      box-shadow: 0 2px 8px rgba(74, 222, 128, 0.3)
    }

    .logo-text {
      font-size: 13px;
      font-weight: 700;
      color: #fff;
      letter-spacing: 1.5px
    }

    .logo-text span {
      color: #4ade80
    }

    .nav-item {
      padding: 10px 16px;
      font-size: 13px;
      cursor: pointer;
      border-left: 2px solid transparent;
      color: #888;
      transition: all 0.1s;
      display: flex;
      align-items: center;
      gap: 8px
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.03);
      color: #ccc
    }

    .nav-item.active {
      background: rgba(74, 222, 128, 0.06);
      color: #fff;
      border-left-color: #4ade80
    }

    .nav-dot {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: currentColor;
      opacity: 0.4
    }

    .nav-item.active .nav-dot {
      opacity: 1;
      background: #4ade80
    }

    .sidebar-status {
      margin-top: auto;
      padding: 10px 16px;
      font-size: 10px;
      color: #444;
      border-top: 1px solid #1a1a1a;
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis
    }

    .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #dc2626;
      display: inline-block;
      flex-shrink: 0
    }

    .dot.on {
      background: #4ade80
    }

    .main {
      flex: 1;
      overflow: hidden;
      background: #f5f5f5;
      display: flex;
      flex-direction: column
    }

    .screen {
      display: none;
      height: 100%
    }

    .screen.active {
      display: flex;
      flex-direction: column;
      height: 100%
    }

    .page {
      display: none;
      flex: 1;
      overflow-y: auto
    }

    .page.active {
      display: flex;
      flex-direction: column
    }

    .page-pad {
      padding: 24px 32px;
      flex: 1
    }

    .page.page-full.active {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden
    }

    .onboard-wrap {
      display: flex;
      align-items: center;
      justify-content: center;
      flex: 1;
      padding: 40px 20px
    }

    .onboard-box {
      width: 100%;
      max-width: 380px
    }

    .onboard-box h1 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 6px;
      color: #111
    }

    .onboard-box p {
      color: #888;
      font-size: 14px;
      line-height: 1.5;
      margin-bottom: 18px
    }

    h2 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 14px;
      color: #111
    }

    .label {
      font-size: 10px;
      font-weight: 700;
      color: #aaa;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      margin-bottom: 4px;
      display: block
    }

    .btn {
      padding: 9px 16px;
      border: none;
      border-radius: 5px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.1s
    }

    .btn:active {
      opacity: 0.65
    }

    .btn:hover {
      opacity: 0.85
    }

    .btn-p {
      background: #111;
      color: #fff
    }

    .btn-d {
      background: #dc2626;
      color: #fff
    }

    .btn-s {
      background: #e8e8e8;
      color: #444
    }

    .btn-g {
      background: #16a34a;
      color: #fff
    }

    .btn-full {
      width: 100%;
      padding: 10px;
      margin: 4px 0;
      display: block
    }

    input,
    textarea {
      width: 100%;
      padding: 8px 11px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 13px;
      margin: 2px 0 10px;
      background: #fff;
      color: #111;
      display: block
    }

    input:focus,
    textarea:focus {
      outline: none;
      border-color: #555;
      box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.06)
    }

    .card {
      background: #fff;
      border: 1px solid #e8e8e8;
      border-radius: 7px;
      padding: 16px 18px;
      margin-bottom: 12px
    }

    .bal-big {
      font-size: 32px;
      font-weight: 700;
      letter-spacing: -1px;
      color: #111
    }

    .bal-unit {
      font-size: 13px;
      color: #aaa;
      margin-left: 4px
    }

    .mono {
      font-family: 'SF Mono', Monaco, Consolas, monospace;
      font-size: 11px;
      word-break: break-all;
      color: #777;
      line-height: 1.5
    }

    .grid3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 12px
    }

    .grid4 {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 12px
    }

    .grid5 {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin-bottom: 12px
    }

    .stat-card {
      background: #fff;
      border: 1px solid #e8e8e8;
      border-radius: 7px;
      padding: 14px 12px;
      text-align: center
    }

    .stat-card .val {
      font-size: 18px;
      font-weight: 700;
      color: #111
    }

    .stat-card .lbl {
      font-size: 10px;
      color: #aaa;
      margin-top: 3px;
      text-transform: uppercase;
      letter-spacing: 0.5px
    }

    .m-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: #dc2626;
      display: inline-block;
      flex-shrink: 0
    }

    .m-dot.on {
      background: #16a34a
    }

    .mnemonic-box {
      background: #fffbeb;
      border: 1px solid #fcd34d;
      padding: 12px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 12px;
      line-height: 1.9;
      margin: 8px 0;
      word-break: break-word
    }

    .tx-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 7px 0;
      border-bottom: 1px solid #f0f0f0;
      font-size: 13px
    }

    .tx-row:last-child {
      border-bottom: none
    }

    .tx-type {
      font-weight: 600;
      min-width: 62px
    }

    .tx-sent .tx-type {
      color: #dc2626
    }

    .tx-recv .tx-type {
      color: #16a34a
    }

    .tx-mine .tx-type {
      color: #2563eb
    }

    .blk-row {
      display: flex;
      gap: 8px;
      padding: 5px 0;
      border-bottom: 1px solid #f5f5f5;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 11px;
      color: #666;
      align-items: center
    }

    .blk-row:last-child {
      border-bottom: none
    }

    .blk-h {
      color: #111;
      font-weight: 600;
      min-width: 38px
    }

    .blk-ts {
      color: #aaa;
      min-width: 70px
    }

    .blk-tx {
      color: #888;
      min-width: 40px
    }

    .blk-miner {
      color: #555;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap
    }

    /* Network map */
    .net-wrap {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding: 0
    }

    .net-header {
      padding: 16px 24px 8px;
      flex-shrink: 0
    }

    .net-legend {
      display: flex;
      gap: 16px;
      padding: 0 24px 10px;
      font-size: 11px;
      color: #888;
      flex-wrap: wrap;
      flex-shrink: 0
    }

    .net-legend-item {
      display: flex;
      align-items: center;
      gap: 5px
    }

    .net-canvas-wrap {
      flex: 1;
      position: relative;
      margin: 0 24px 24px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #e8e8e8;
      background: #fff
    }

    #bubbleCanvas {
      width: 100%;
      height: 100%;
      display: block;
      cursor: crosshair
    }

    .net-tooltip {
      position: fixed;
      background: #0a0a0a;
      color: #e5e5e5;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 12px;
      pointer-events: none;
      z-index: 9999;
      display: none;
      line-height: 1.6;
      min-width: 200px;
      max-width: 320px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      border: 1px solid #2a2a2a;
      backdrop-filter: blur(8px)
    }

    .net-tooltip b {
      color: #4ade80;
      font-weight: 600
    }

    .net-tooltip .tt-addr {
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 9px;
      color: #666;
      display: block;
      margin-top: 4px;
      word-break: break-all;
      background: #1a1a1a;
      padding: 6px 8px;
      border-radius: 4px;
      margin-bottom: 8px
    }

    .net-tooltip .tt-row {
      display: flex;
      justify-content: space-between;
      padding: 3px 0;
      border-bottom: 1px solid #222
    }

    .net-tooltip .tt-row:last-child {
      border-bottom: none
    }

    .net-tooltip .tt-label {
      color: #888;
      font-size: 11px
    }

    .net-tooltip .tt-value {
      color: #fff;
      font-weight: 500
    }

    .net-status-bar {
      padding: 6px 24px 8px;
      font-size: 11px;
      color: #aaa;
      flex-shrink: 0;
      display: flex;
      justify-content: space-between
    }

    .link {
      color: #2563eb;
      cursor: pointer;
      font-size: 13px
    }

    .link:hover {
      text-decoration: underline
    }

    .hidden {
      display: none !important
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- SIDEBAR (hidden during onboarding) -->
    <div class="sidebar" id="sidebar" style="display:none">
      <div class="logo">
        <div class="logo-mark">K</div>
        <div class="logo-text">KNOT<span>COIN</span></div>
      </div>
      <div class="nav-item active" data-page="dashboard"><span class="nav-dot"></span>Dashboard</div>
      <div class="nav-item" data-page="send"><span class="nav-dot"></span>Send</div>
      <div class="nav-item" data-page="receive"><span class="nav-dot"></span>Receive</div>
      <div class="nav-item" data-page="mining"><span class="nav-dot"></span>Mining</div>
      <div class="nav-item" data-page="referrals"><span class="nav-dot"></span>Referrals</div>
      <div class="nav-item" data-page="governance"><span class="nav-dot"></span>Governance</div>
      <div class="nav-item" data-page="network"><span class="nav-dot"></span>Network</div>
      <div class="nav-item" data-page="settings"><span class="nav-dot"></span>Settings</div>
      <div class="sidebar-status"><span class="dot" id="dot"></span><span id="status">Connecting...</span></div>
    </div>
    <div class="main">

      <!-- ONBOARD: Welcome -->
      <div id="s0" class="screen active">
        <div class="onboard-wrap">
          <div class="onboard-box">
            <h1>Knotcoin</h1>
            <p>Quantum-secure electronic cash with referral mining.</p>
            <label class="label" for="ref">Referral Code (optional)</label>
            <input type="text" id="ref" placeholder="Paste referral link or code">
            <p style="font-size:12px;color:#aaa;margin:-6px 0 18px">If someone referred you, enter their code. You can
              skip this.</p>
            <button class="btn btn-p btn-full" id="b0">Create New Wallet</button>
            <button class="btn btn-s btn-full" id="b1">Import Existing Wallet</button>
          </div>
        </div>
      </div>

      <!-- ONBOARD: Show mnemonic -->
      <div id="s1" class="screen">
        <div class="onboard-wrap">
          <div class="onboard-box">
            <h1>Save Your Mnemonic</h1>
            <p>Write down these 24 words. This is your only backup.</p>
            <div class="mnemonic-box" id="newm">Generating...</div>
            <p style="font-size:12px;color:#dc2626;margin-bottom:12px">Never share this. Store it offline.</p>
            <div style="background:#1a1a1a;border:1px solid #333;border-radius:6px;padding:12px;margin-bottom:16px">
              <p style="font-size:11px;color:#fbbf24;margin:0 0 6px;font-weight:600">⚠️ Important: Backup Your Keys File
              </p>
              <p style="font-size:11px;color:#aaa;margin:0">Knotcoin uses quantum-resistant Dilithium3 keys which cannot
                be regenerated from mnemonic alone. After creating your wallet, also backup:<br><code
                  style="background:#333;padding:2px 6px;border-radius:3px;font-size:10px">~/.knotcoin/mainnet/wallet_keys.json</code>
              </p>
            </div>
            <button class="btn btn-p btn-full" id="b2">I Saved My Mnemonic — Continue</button>
            <button class="btn btn-s btn-full" id="b3">Back</button>
          </div>
        </div>
      </div>

      <!-- ONBOARD: Import -->
      <div id="s2" class="screen">
        <div class="onboard-wrap">
          <div class="onboard-box">
            <h1>Import Wallet</h1>
            <p>Enter your 24-word mnemonic phrase.</p>
            <textarea id="impm" rows="4" placeholder="word1 word2 word3 ..."></textarea>
            <button class="btn btn-p btn-full" id="b4">Import</button>
            <button class="btn btn-s btn-full" id="b5">Back</button>
          </div>
        </div>
      </div>

      <!-- MAIN WALLET VIEW -->
      <div id="s3" class="screen">

        <!-- Dashboard -->
        <div id="pg-dashboard" class="page active">
          <div class="page-pad">
            <h2>Dashboard</h2>
            <div class="card">
              <div class="label">Balance</div>
              <div><span class="bal-big" id="bal">0.00000000</span><span class="bal-unit">KOT</span></div>
              <div class="mono" style="margin-top:8px;cursor:pointer" id="addr" title="Click to copy">Loading...</div>
            </div>
            <div class="grid5">
              <div class="stat-card">
                <div class="val" id="h">0</div>
                <div class="lbl">Block Height</div>
              </div>
              <div class="stat-card">
                <div class="val" id="p">0</div>
                <div class="lbl">Peers</div>
              </div>
              <div class="stat-card">
                <div class="val" id="m">0</div>
                <div class="lbl">Mempool</div>
              </div>
              <div class="stat-card">
                <div class="val" id="dashbal">0</div>
                <div class="lbl">KOT Balance</div>
              </div>
              <div class="stat-card">
                <div class="val" id="ghr">0</div>
                <div class="lbl">Global Hashrate</div>
              </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
              <div class="card">
                <div class="label">Recent Transactions</div>
                <div id="txhist" style="font-size:13px;color:#888">No transactions yet</div>
              </div>
              <div class="card">
                <div class="label">Pending Mempool (Top 10)</div>
                <div id="mempool" style="font-size:12px;color:#888">No pending transactions</div>
              </div>
              <div class="card">
                <div class="label">Latest Blocks</div>
                <div id="blocks" style="max-height:200px;overflow-y:auto">Loading...</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Send -->
        <div id="pg-send" class="page">
          <div class="page-pad">
            <h2>Send KOT</h2>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
              <div class="card">
                <div class="label">Recipient Address</div>
                <input type="text" id="sendto" placeholder="Paste destination address">
                <div class="label">Amount (KOT)</div>
                <input type="number" id="sendamt" placeholder="0.00000000" step="0.00000001">
                <button class="btn btn-p btn-full" id="b6">Send KOT</button>
                <div id="sendres" class="hidden"
                  style="margin-top:10px;padding:10px;background:#f5f5f5;border-radius:5px;font-size:13px"></div>
              </div>
              <div class="card">
                <div class="label">Your Balance</div>
                <div style="font-size:24px;font-weight:700;margin:4px 0 2px" id="sendbalpre">0</div>
                <div style="font-size:12px;color:#aaa">KOT available</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Receive -->
        <div id="pg-receive" class="page">
          <div class="page-pad">
            <h2>Receive KOT</h2>
            <div class="card">
              <div class="label">Your Address</div>
              <div class="mono" id="recaddr" style="padding:10px 0;cursor:pointer;font-size:12px" title="Click to copy">
                Loading...</div>
              <button class="btn btn-s btn-full" id="b7">Copy Address</button>
              <p style="font-size:12px;color:#aaa;margin-top:8px">Share this address to receive KOT.</p>
            </div>
          </div>
        </div>

        <!-- Mining -->
        <div id="pg-mining" class="page">
          <div class="page-pad">
            <h2>Mining</h2>
            <div class="grid4" style="margin-bottom:14px">
              <div class="stat-card">
                <div class="val" id="mhr">0 H/s</div>
                <div class="lbl">Hashrate</div>
              </div>
              <div class="stat-card">
                <div class="val" id="mbf">0</div>
                <div class="lbl">Blocks Found</div>
              </div>
              <div class="stat-card">
                <div class="val" id="mdiff">--</div>
                <div class="lbl">Difficulty</div>
              </div>
              <div class="stat-card">
                <div class="val" id="mut">--</div>
                <div class="lbl">Uptime</div>
              </div>
            </div>
            <div class="card" style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
              <div class="m-dot" id="mdot"></div>
              <div style="flex:1"><span style="font-weight:600" id="mtext">Stopped</span>
                <div style="font-size:11px;color:#aaa;margin-top:2px" id="maddr"></div>
              </div>
            </div>
            <div class="card">
              <div class="label">Mining Threads (1-8, capped for fairness)</div>
              <input type="number" id="mthreads" min="1" max="8" value="4" style="width:80px">
              <p style="font-size:11px;color:#888;margin-top:4px">Higher threads = more hashrate, but capped at 8 to
                keep mining fair for consumer hardware.</p>
            </div>
            <button class="btn btn-p btn-full" id="b8">Start Mining</button>
            <div class="card" style="margin-top:12px">
              <div class="label">Mining Log</div>
              <div id="mlog"
                style="font-family:monospace;font-size:10px;max-height:150px;overflow-y:auto;background:#1a1a1a;color:#4ade80;padding:8px;border-radius:4px">
                Waiting to start mining...</div>
            </div>
          </div>
        </div>

        <!-- Referrals -->
        <div id="pg-referrals" class="page">
          <div class="page-pad">
            <h2>Referrals</h2>
            <div class="card">
              <div class="label">Your Referral Status</div>
              <div id="refstatus" style="display:flex;align-items:center;gap:8px;padding:8px 0">
                <span id="refstatdot" style="width:10px;height:10px;border-radius:50%;background:#666"></span>
                <span id="refstattext" style="font-size:13px;color:#888">Checking...</span>
              </div>
            </div>
            <div class="card">
              <div class="label">Your Referral Link</div>
              <div class="mono" id="rlink" style="padding:8px 0;cursor:pointer;font-size:12px"
                title="Click to copy — share to earn 5%">--</div>
              <p style="font-size:12px;color:#aaa;margin-top:4px">Earn 5% of every block reward mined by your referrals.
              </p>
            </div>
            <div class="grid3">
              <div class="stat-card">
                <div class="val" id="rc">0</div>
                <div class="lbl">Referred Miners</div>
              </div>
              <div class="stat-card" style="grid-column:span 2">
                <div class="val" id="re">0.00000000</div>
                <div class="lbl">Total Earned (KOT)</div>
              </div>
            </div>
            <div class="card" style="margin-top:12px;background:#1a1a1a;border-color:#333">
              <div class="label" style="color:#fbbf24">Referral Bonus Requirements</div>
              <ul style="font-size:11px;color:#aaa;margin:8px 0 0 16px;line-height:1.8">
                <li><b style="color:#fff">You must mine at least 1 block</b> to become a valid referrer</li>
                <li><b style="color:#fff">Stay active</b> — mine within the last 2,880 blocks (~48 hours)</li>
                <li><b style="color:#fff">5% bonus</b> is protocol-minted when your referrals mine (not deducted from
                  them)</li>
                <li>Referred users must register your code via their first transaction</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Governance -->
        <div id="pg-governance" class="page">
          <div class="page-pad">
            <h2>Governance</h2>
            <div class="grid4" style="margin-bottom:14px">
              <div class="stat-card">
                <div class="val" id="gw">--</div>
                <div class="lbl">Weight (bps)</div>
              </div>
              <div class="stat-card">
                <div class="val" id="gwp">--</div>
                <div class="lbl">Weight %</div>
              </div>
              <div class="stat-card">
                <div class="val" id="gcap">--</div>
                <div class="lbl">Cap (bps)</div>
              </div>
              <div class="stat-card">
                <div class="val" id="gstat">--</div>
                <div class="lbl">Status</div>
              </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
              <div class="card">
                <div class="label">Create Proposal (Hash)</div>
                <textarea id="gtext" placeholder="Write proposal text here (this will be hashed locally)"
                  style="width:100%;height:90px;margin-bottom:8px"></textarea>
                <button class="btn btn-s btn-full" id="bgovhash">Generate Proposal Hash</button>
                <div id="govhashres" class="hidden"
                  style="margin-top:8px;padding:10px;background:#f5f5f5;border-radius:5px;font-size:12px;word-break:break-all"></div>
              </div>
              <div class="card">
                <div class="label">Signal Vote</div>
                <input type="text" id="ghex" placeholder="Proposal hash (64 hex chars)">
                <button class="btn btn-p btn-full" id="bgovsend">Send Signal</button>
                <div id="govsendres" class="hidden"
                  style="margin-top:8px;padding:10px;background:#f5f5f5;border-radius:5px;font-size:13px"></div>
              </div>
              <div class="card">
                <div class="label">Check Tally</div>
                <input type="text" id="gtally" placeholder="Proposal hash (64 hex chars)">
                <button class="btn btn-s btn-full" id="bgovtally">Get Tally</button>
                <div id="govtallyres" class="hidden"
                  style="margin-top:8px;padding:10px;background:#f5f5f5;border-radius:5px;font-size:13px"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Network -->
        <div id="pg-network" class="page page-full">
          <div class="net-wrap">
            <div class="net-header">
              <h2 style="margin-bottom:8px">Network Explorer</h2>
              <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:10px">
                <div class="stat-card">
                  <div class="val" id="net-miners">--</div>
                  <div class="lbl">Total Miners</div>
                </div>
                <div class="stat-card">
                  <div class="val" id="net-active">--</div>
                  <div class="lbl">Active Now</div>
                </div>
                <div class="stat-card">
                  <div class="val" id="net-addrs">--</div>
                  <div class="lbl">Addresses (balance&gt;0)</div>
                </div>
                <div class="stat-card">
                  <div class="val" id="net-hashrate">--</div>
                  <div class="lbl">Network H/s</div>
                </div>
                <div class="stat-card">
                  <div class="val" id="net-height">--</div>
                  <div class="lbl">Block Height</div>
                </div>
              </div>
            </div>
            <div class="net-legend">
              <div class="net-legend-item"><span
                  style="width:9px;height:9px;border-radius:50%;background:#16a34a;display:inline-block"></span> Mining
              </div>
              <div class="net-legend-item"><span
                  style="width:9px;height:9px;border-radius:50%;background:#1a1a1a;display:inline-block"></span>
                Inactive</div>
              <div class="net-legend-item"><span
                  style="width:9px;height:9px;border-radius:50%;background:#2563eb;display:inline-block"></span> You
              </div>
              <div class="net-legend-item"><span
                  style="width:18px;height:1px;background:#4ade80;display:inline-block"></span> Referral link</div>
              <div class="net-legend-item"><span
                  style="width:18px;height:1px;background:#fbbf24;display:inline-block;border-top:1px dashed #fbbf24"></span>
                Recent TX</div>
            </div>
            <div class="net-canvas-wrap"><canvas id="bubbleCanvas"></canvas></div>
            <div class="net-status-bar"><span id="binfo">Loading...</span><span id="btime"></span></div>
            <div style="padding:0 24px 16px;display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap">
              <div class="card" style="flex:1;min-width:280px;margin:0">
                <div class="label">Block Search</div>
                <div style="display:flex;gap:8px">
                  <input type="number" id="blk-search" placeholder="Enter block height" min="1" style="flex:1;margin:0">
                  <button class="btn btn-p" id="btn-blk-search">Search</button>
                </div>
                <div id="blk-result" class="hidden"
                  style="margin-top:12px;font-size:12px;line-height:1.8;background:#fafafa;padding:12px;border-radius:6px;position:relative">
                  <button id="blk-close"
                    style="position:absolute;top:8px;right:8px;background:none;border:none;font-size:18px;cursor:pointer;color:#888">&times;</button>
                  <div style="font-weight:600;margin-bottom:8px;font-size:14px">Block #<span id="blk-h">--</span></div>
                  <div class="mono"
                    style="font-size:9px;word-break:break-all;color:#666;margin-bottom:10px;background:#f0f0f0;padding:6px;border-radius:4px"
                    id="blk-hash">--</div>
                  <div style="display:grid;grid-template-columns:100px 1fr;gap:6px">
                    <div><b>Miner:</b></div>
                    <div class="mono" style="font-size:9px;word-break:break-all" id="blk-miner">--</div>
                    <div><b>Reward:</b></div>
                    <div><span id="blk-reward">--</span> KOT</div>
                    <div><b>Difficulty:</b></div>
                    <div id="blk-diff">--</div>
                    <div><b>Time:</b></div>
                    <div id="blk-time">--</div>
                    <div><b>Transactions:</b></div>
                    <div id="blk-txs">--</div>
                  </div>
                  <div style="margin-top:8px;font-size:10px;color:#888"><b>Prev:</b> <span id="blk-prev"
                      class="mono">--</span></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Settings -->
        <div id="pg-settings" class="page">
          <div class="page-pad">
            <h2>Settings</h2>
            <div class="card">
              <div class="label">Backup Mnemonic</div>
              <button class="btn btn-s btn-full" id="b9">Reveal Mnemonic</button>
              <div class="mnemonic-box hidden" id="mrev">--</div>
              <div
                style="margin-top:12px;padding:10px;background:#fef3c7;border-radius:6px;font-size:11px;color:#92400e">
                <b>⚠️ Post-Quantum Wallet Notice:</b> Your address is derived deterministically from your 24-word
                mnemonic. Keep the mnemonic safe &mdash; it is enough to restore the same address. If you also back up
                <code>~/.knotcoin/mainnet/wallet_keys.json</code>, restores are faster.
              </div>
            </div>
            <div class="card" style="border-color:#fecaca">
              <div class="label" style="color:#dc2626">Danger Zone</div>
              <p style="font-size:12px;color:#888;margin-bottom:8px">Permanently delete wallet from this device. <b>This
                  will delete your keys!</b> Backup wallet_keys.json first.</p>
              <button class="btn btn-d btn-full" id="b10">Delete Wallet</button>
            </div>
          </div>
        </div>

      </div><!-- end s3 -->
    </div><!-- end main -->
  </div><!-- end app -->
  <div id="nettooltip" class="net-tooltip"></div>
  <script>
    const RPC_BASE = (typeof window !== 'undefined' && window.__KNOTCOIN_RPC__) ? window.__KNOTCOIN_RPC__ : 'http://127.0.0.1:9001';
    const RPC = RPC_BASE.endsWith('/rpc') ? RPC_BASE : (RPC_BASE + '/rpc');
    const K = 100000000;
    let auth = '', w = { m: null, a: null, b: 0 }, c = { h: 0, p: 0, mp: 0 }, mi = { act: false, threads: 4 }, r = { c: '', n: 0, e: 0 }, netStats = { miners: 0, active: 0, addrs: 0, netHashrate: 0 };
    let timer = null, temp = null, lastBlocksHeight = -1, syncRunning = false;
    const $ = id => document.getElementById(id);

    function formatUptime(s) {
      if (s < 60) return s + 's';
      if (s < 3600) return Math.floor(s / 60) + 'm ' + s % 60 + 's';
      return Math.floor(s / 3600) + 'h ' + Math.floor((s % 3600) / 60) + 'm';
    }

    function normalizeRefInput(v) {
      v = (v || '').trim();
      if (!v) return '';
      try { if (v.includes('ref=')) { const u = new URL(v); const r = u.searchParams.get('ref'); if (r) v = r; } }
      catch (e) { const m = v.match(/ref=([0-9a-fA-F]{16})/); if (m) v = m[1]; }
      v = v.trim();
      if (v.toLowerCase().startsWith('kot')) v = v.replace(/^kot1?/i, '');
      return v;
    }

    async function promptAuthToken() {
      let t = localStorage.getItem('knotcoin_auth') || '';
      if (!t) t = prompt('Enter RPC Auth Token (from ~/.knotcoin/mainnet/.cookie):') || '';
      t = (t || '').trim();
      if (t) {
        localStorage.setItem('knotcoin_auth', t);
        auth = t;
      }
      return t;
    }

    async function rpc(m, p = [], timeoutMs = 8000) {
      const h = { 'Content-Type': 'application/json' };
      if (auth) h['Authorization'] = 'Bearer ' + auth;
      const ctrl = new AbortController();
      const tid = setTimeout(() => ctrl.abort(), timeoutMs);
      try {
        let res = await fetch(RPC, { method: 'POST', headers: h, body: JSON.stringify({ jsonrpc: '2.0', method: m, params: p, id: Date.now() }), signal: ctrl.signal });
        if (res.status === 401 && !window.__TAURI__) {
          await promptAuthToken();
          const h2 = { 'Content-Type': 'application/json' };
          if (auth) h2['Authorization'] = 'Bearer ' + auth;
          res = await fetch(RPC, { method: 'POST', headers: h2, body: JSON.stringify({ jsonrpc: '2.0', method: m, params: p, id: Date.now() }), signal: ctrl.signal });
        }
        if (!res.ok) {
          let emsg = res.statusText;
          try { const ed = await res.json(); if (ed.error) emsg = ed.error.message || JSON.stringify(ed.error); } catch (_) { }
          throw new Error(emsg);
        }
        const d = await res.json();
        if (d.error) throw new Error(d.error.message || JSON.stringify(d.error));
        return d.result;
      } catch (e) {
        throw e;
      } finally { clearTimeout(tid); }
    }

    async function maybeRegisterReferral() {
      try {
        if (!w.m || !w.a) return;
        const rfRaw = localStorage.getItem('knotcoin_referrer') || '';
        const rf = normalizeRefInput(rfRaw);
        if (!rf) return;
        const bal = await rpc('getbalance', [w.a]);
        if ((bal.nonce || 0) !== 0) return;
        if ((bal.balance_knots || 0) < 1) return;
        const info = await rpc('getreferralinfo', [w.a]);
        if (info && info.referred_by) return;
        await rpc('wallet_register_referral', [w.m, rfRaw]);
      } catch (e) { }
    }

    // ── Interactive Network Map ─────────────────────────────────────────
    let netNodes = [], netHover = -1, netAnimFrame = null, netData = null, netTxAnims = [], netLastFetch = 0, netTooltipSetup = false;
    let netPendingRebuild = true, netLastSize = { w: 0, h: 0 }, netLastDraw = 0;
    const NET_MAX_FPS = 30;

    async function fetchNetData() {
      try {
        const [dr, tr, ar] = await Promise.allSettled([
          rpc('get_all_miners', [], 12000),
          w.a ? rpc('gettransactionhistory', [w.a, 5]) : Promise.resolve({ transactions: [] }),
          rpc('getaddressstats', [], 12000)
        ]);
        if (dr.status === 'fulfilled') {
          netData = dr.value;
          netPendingRebuild = true;
          const miners = netData.miners || [];
          netStats.miners = miners.length;
          netStats.active = miners.filter(m => m.is_mining).length;
          if (ar.status === 'fulfilled') {
            netStats.addrs = ar.value.nonzero_accounts || 0;
          } else {
            netStats.addrs = miners.filter(m => (m.balance_knots || 0) > 0).length;
          }
          set('net-miners', el => el.textContent = netStats.miners);
          set('net-active', el => el.textContent = netStats.active);
          set('net-addrs', el => el.textContent = netStats.addrs);
          set('net-height', el => el.textContent = c.h || '--');
        }
        if (tr.status === 'fulfilled' && netNodes.length) {
          const idx = {}; netNodes.forEach(n => idx[n.addr] = n);
          (tr.value.transactions || []).filter(t => t.type === 'sent').forEach(tx => {
            if (idx[tx.address] && idx[w.a] && !netTxAnims.find(a => a.txid === tx.txid)) {
              netTxAnims.push({ from: idx[w.a], to: idx[tx.address], prog: 0, txid: tx.txid || Date.now() });
            }
          });
        }
      } catch (e) { }
    }

    // Store dragged positions to preserve them across redraws
    let draggedPositions = {};

    function buildNetNodes(W, H) {
      const rawMiners = (netData && netData.miners) || [];
      if (!rawMiners.length) return [];

      let miners = [...rawMiners];
      const addrMap = new Map();
      miners.forEach(m => addrMap.set(m.address, m));
      miners.forEach(m => {
        if (m.referrer && !addrMap.has(m.referrer)) {
          const dummy = { address: m.referrer, blocks_mined: 0, balance_kot: '0', is_mining: false, referrer: null };
          miners.push(dummy);
          addrMap.set(m.referrer, dummy);
        }
      });

      const maxB = Math.max(1, ...miners.map(m => m.blocks_mined || 1));
      const cx = W / 2, cy = H / 2, rad = Math.min(W, H) * 0.36;
      return miners.map((m, i) => {
        const addr = m.address || '';
        const a = (2 * Math.PI * i) / miners.length - Math.PI / 2;
        const sz = Math.max(18, Math.sqrt((m.blocks_mined || 1) / maxB) * 50);
        // Use dragged position if available, otherwise calculate default
        const defaultX = cx + rad * Math.cos(a);
        const defaultY = cy + rad * Math.sin(a);
        const pos = draggedPositions[addr] || { x: defaultX, y: defaultY };
        return {
          x: pos.x, y: pos.y, r: sz, addr: addr,
          addrShort: addr.slice(0, 8) + '...' + addr.slice(-6),
          blocks: m.blocks_mined || 0, balance: m.balance_kot || '0', isMining: !!m.is_mining,
          isMe: !!(w.a && addr === w.a), ref: m.referrer || null, phase: i * 0.9,
          reward: m.total_reward_kot || '0'
        };
      });
    }

    function drawNet() {
      const canvas = $('bubbleCanvas');
      if (!canvas || !canvas.isConnected) return;
      const ctx = canvas.getContext('2d');
      const dpr = window.devicePixelRatio || 1;
      const W = canvas.clientWidth, H = canvas.clientHeight;
      if (!W || !H) return;
      if (canvas.width !== Math.round(W * dpr) || canvas.height !== Math.round(H * dpr)) {
        canvas.width = Math.round(W * dpr); canvas.height = Math.round(H * dpr); ctx.scale(dpr, dpr);
      }
      ctx.clearRect(0, 0, W, H);
      if (!netData || !(netData.miners && netData.miners.length)) {
        ctx.fillStyle = '#bbb'; ctx.font = '13px sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.fillText(netData ? 'No miners on network yet' : 'Fetching network data...', W / 2, H / 2);
        return;
      }
      if (netPendingRebuild || netLastSize.w !== W || netLastSize.h !== H || !netNodes.length) {
        netNodes = buildNetNodes(W, H);
        netPendingRebuild = false;
        netLastSize = { w: W, h: H };
      }
      const nodes = netNodes;
      const idx = {}; nodes.forEach(n => idx[n.addr] = n);
      const t = Date.now() * 0.001;

      // Referral lines with arrows (always visible, brighter on hover)
      nodes.forEach(n => {
        if (!n.ref || !idx[n.ref]) return;
        const tgt = idx[n.ref]; // tgt is the referrer
        const hov = netHover >= 0 && (nodes[netHover]?.addr === n.addr || nodes[netHover]?.addr === n.ref);
        ctx.save();
        // Draw gradient line from referred to referrer
        const grad = ctx.createLinearGradient(n.x, n.y, tgt.x, tgt.y);
        grad.addColorStop(0, hov ? 'rgba(74,222,128,0.9)' : 'rgba(74,222,128,0.4)');
        grad.addColorStop(1, hov ? 'rgba(34,197,94,0.9)' : 'rgba(34,197,94,0.25)');
        ctx.strokeStyle = grad;
        ctx.lineWidth = hov ? 3 : 1.5;
        ctx.beginPath(); ctx.moveTo(n.x, n.y); ctx.lineTo(tgt.x, tgt.y); ctx.stroke();
        // Arrow head pointing to referrer (always visible)
        const dx = tgt.x - n.x, dy = tgt.y - n.y, d = Math.sqrt(dx * dx + dy * dy) || 1;
        const arrowPos = 0.7; // Position along line
        const mx = n.x + dx * arrowPos, my = n.y + dy * arrowPos;
        const nx2 = dx / d, ny2 = dy / d;
        const arrowSize = hov ? 10 : 6;
        ctx.fillStyle = hov ? '#4ade80' : 'rgba(74,222,128,0.6)';
        ctx.beginPath();
        ctx.moveTo(mx + nx2 * arrowSize, my + ny2 * arrowSize);
        ctx.lineTo(mx - ny2 * arrowSize * 0.6 - nx2 * arrowSize * 0.3, my + nx2 * arrowSize * 0.6 - ny2 * arrowSize * 0.3);
        ctx.lineTo(mx + ny2 * arrowSize * 0.6 - nx2 * arrowSize * 0.3, my - nx2 * arrowSize * 0.6 - ny2 * arrowSize * 0.3);
        ctx.closePath(); ctx.fill();
        ctx.restore();
      });

      // TX animations (money moving)
      netTxAnims = netTxAnims.filter(a => a.prog < 1);
      netTxAnims.forEach(a => {
        a.prog = Math.min(1, a.prog + 0.006);
        const f = a.from, t2 = a.to; if (!f || !t2) return;
        const px = f.x + (t2.x - f.x) * a.prog, py = f.y + (t2.y - f.y) * a.prog;
        ctx.save();
        ctx.strokeStyle = 'rgba(251,191,36,0.3)'; ctx.lineWidth = 1.5; ctx.setLineDash([3, 7]);
        ctx.beginPath(); ctx.moveTo(f.x, f.y); ctx.lineTo(t2.x, t2.y); ctx.stroke();
        ctx.setLineDash([]); ctx.fillStyle = '#fbbf24';
        ctx.beginPath(); ctx.arc(px, py, 5, 0, Math.PI * 2); ctx.fill();
        ctx.restore();
      });

      // Nodes
      nodes.forEach((n, i) => {
        const hov = netHover === i;
        const pulse = 0.5 + 0.5 * Math.sin(t * 2.2 + n.phase);
        if (n.isMining) {
          ctx.save(); ctx.strokeStyle = `rgba(22,163,74,${0.2 + 0.4 * pulse})`; ctx.lineWidth = 2;
          ctx.beginPath(); ctx.arc(n.x, n.y, n.r + 5 + 8 * pulse, 0, Math.PI * 2); ctx.stroke(); ctx.restore();
        }
        if (hov) {
          ctx.save(); ctx.strokeStyle = 'rgba(255,255,255,0.45)'; ctx.lineWidth = 2.5;
          ctx.beginPath(); ctx.arc(n.x, n.y, n.r + 7, 0, Math.PI * 2); ctx.stroke(); ctx.restore();
        }
        ctx.fillStyle = n.isMe ? '#2563eb' : n.isMining ? '#16a34a' : '#1a1a1a';
        ctx.beginPath(); ctx.arc(n.x, n.y, n.r, 0, Math.PI * 2); ctx.fill();
        if (n.r > 11) {
          ctx.fillStyle = 'rgba(255,255,255,0.92)';
          ctx.font = `bold ${Math.min(n.r * 0.44, 12)}px sans-serif`;
          ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
          ctx.fillText(n.blocks > 999 ? Math.round(n.blocks / 1000) + 'k' : n.blocks, n.x, n.y);
        }
        if (n.isMe) {
          ctx.fillStyle = 'rgba(255,255,255,0.55)'; ctx.font = '9px sans-serif';
          ctx.textAlign = 'center'; ctx.textBaseline = 'top';
          ctx.fillText('YOU', n.x, n.y + n.r + 3);
        }
      });
      ctx.textBaseline = 'alphabetic';
      set('binfo', el => el.textContent = nodes.length + ' nodes');
    }

    function netLoop() {
      if (Date.now() - netLastFetch > 5000) { netLastFetch = Date.now(); fetchNetData(); }
      const now = Date.now();
      if (now - netLastDraw >= (1000 / NET_MAX_FPS)) {
        netLastDraw = now;
        drawNet();
      }
      netAnimFrame = requestAnimationFrame(netLoop);
    }

    function startNetMap() {
      if (!netTooltipSetup) { setupNetTooltip(); netTooltipSetup = true; }
      if (netAnimFrame) cancelAnimationFrame(netAnimFrame);
      netLastFetch = 0; netPendingRebuild = true; fetchNetData();
      netAnimFrame = requestAnimationFrame(netLoop);
    }

    function stopNetMap() {
      if (netAnimFrame) { cancelAnimationFrame(netAnimFrame); netAnimFrame = null; }
      set('nettooltip', el => el.style.display = 'none');
    }

    function setupNetTooltip() {
      const canvas = $('bubbleCanvas');
      if (!canvas) return;

      // Drag state - shared across handlers
      let dragIdx = -1, dragOffX = 0, dragOffY = 0;

      // Combined mousemove handler for both tooltip and drag
      canvas.addEventListener('mousemove', e => {
        const rect = canvas.getBoundingClientRect();
        const mx = e.clientX - rect.left, my = e.clientY - rect.top;

        // Handle drag first (higher priority)
        if (dragIdx >= 0 && netNodes[dragIdx]) {
          const newX = mx + dragOffX;
          const newY = my + dragOffY;
          netNodes[dragIdx].x = newX;
          netNodes[dragIdx].y = newY;
          // Save dragged position
          draggedPositions[netNodes[dragIdx].addr] = { x: newX, y: newY };
          drawNet();
          $('nettooltip').style.display = 'none';
          return;
        }

        // Tooltip handling
        let found = -1;
        for (let i = 0; i < netNodes.length; i++) {
          const n = netNodes[i];
          const dx = n.x - mx, dy = n.y - my;
          if (Math.sqrt(dx * dx + dy * dy) < n.r + 8) { found = i; break; }
        }
        netHover = found;
        const tip = $('nettooltip');
        if (found >= 0) {
          const n = netNodes[found];
          const statusColor = n.isMining ? '#4ade80' : (n.isMe ? '#2563eb' : '#666');
          const statusText = n.isMining ? '⚡ Mining' : (n.isMe ? 'Your Wallet' : 'Inactive');
          tip.innerHTML =
            '<div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid #333">' +
            '<span style="width:12px;height:12px;border-radius:50%;background:' + statusColor + ';box-shadow:0 0 8px ' + statusColor + '"></span>' +
            '<b style="font-size:15px;color:#fff">' + (n.isMe ? 'Your Address' : 'Miner') + '</b>' +
            '<span style="font-size:11px;color:' + statusColor + ';margin-left:auto;font-weight:600">' + statusText + '</span>' +
            '</div>' +
            '<div class="tt-addr" style="margin-bottom:10px">' + n.addr + '</div>' +
            '<div class="tt-row"><span class="tt-label">Blocks Mined</span><span class="tt-value" style="color:#4ade80;font-weight:700">' + n.blocks + '</span></div>' +
            '<div class="tt-row"><span class="tt-label">Balance</span><span class="tt-value" style="color:#fbbf24;font-weight:700">' + (n.balance || '0') + ' KOT</span></div>' +
            '<div class="tt-row"><span class="tt-label">Total Rewards</span><span class="tt-value" style="color:#60a5fa">' + (n.reward || '0') + ' KOT</span></div>' +
            (n.ref ? '<div class="tt-row" style="margin-top:6px;padding-top:6px;border-top:1px solid #333"><span class="tt-label">Referrer</span><span class="tt-value" style="font-size:9px;color:#4ade80">' + n.ref.slice(0, 12) + '...' + n.ref.slice(-6) + '</span></div>' : '');
          const tx = e.clientX, ty = e.clientY;
          tip.style.display = 'block';
          const tW = tip.offsetWidth || 240;
          const tH = tip.offsetHeight || 150;
          tip.style.left = Math.min(tx + 16, window.innerWidth - tW - 20) + 'px';
          tip.style.top = Math.min(Math.max(10, ty - 50), window.innerHeight - tH - 20) + 'px';
          canvas.style.cursor = 'grab';
        } else {
          tip.style.display = 'none';
          canvas.style.cursor = 'default';
        }
      });

      canvas.addEventListener('mouseleave', () => {
        netHover = -1;
        if (dragIdx >= 0 && netNodes[dragIdx]) {
          draggedPositions[netNodes[dragIdx].addr] = { x: netNodes[dragIdx].x, y: netNodes[dragIdx].y };
        }
        dragIdx = -1;
        canvas.style.cursor = 'default';
        set('nettooltip', el => el.style.display = 'none');
      });

      // Mousedown - start drag
      canvas.addEventListener('mousedown', e => {
        const rect = canvas.getBoundingClientRect();
        const mx = e.clientX - rect.left, my = e.clientY - rect.top;
        dragIdx = -1;
        for (let i = 0; i < netNodes.length; i++) {
          const n = netNodes[i];
          const dx = n.x - mx, dy = n.y - my;
          if (Math.sqrt(dx * dx + dy * dy) < n.r + 6) {
            dragIdx = i;
            dragOffX = dx;
            dragOffY = dy;
            break;
          }
        }
        if (dragIdx >= 0) {
          canvas.style.cursor = 'grabbing';
          e.preventDefault();
        }
      });

      // Mouseup - end drag and save position
      canvas.addEventListener('mouseup', () => {
        if (dragIdx >= 0 && netNodes[dragIdx]) {
          draggedPositions[netNodes[dragIdx].addr] = { x: netNodes[dragIdx].x, y: netNodes[dragIdx].y };
        }
        dragIdx = -1;
        canvas.style.cursor = 'default';
      });
    }

    function startSync() {
      if (timer) return;
      timer = setInterval(sync, 2000); // Real-time updates every 2 seconds
      sync();
    }

    async function sync() {
      if (syncRunning) return;
      syncRunning = true;
      try {
        // Fire core RPC calls in parallel
        const [infoRes, peerRes, msRes, netHrRes] = await Promise.allSettled([
          rpc('getmininginfo'),
          rpc('getpeerinfo'),
          rpc('get_mining_status'),
          rpc('getnetworkhashrate')
        ]);

        if (infoRes.status === 'fulfilled') { c.h = infoRes.value.blocks || 0; c.mp = infoRes.value.mempool || 0; }
        if (peerRes.status === 'fulfilled') { c.p = peerRes.value.peer_count || 0; }

        if (msRes.status === 'fulfilled') {
          const ms = msRes.value;
          mi.act = !!ms.active;
          set('mdot', el => { if (mi.act) el.classList.add('on'); else el.classList.remove('on'); });
          set('mtext', el => el.textContent = mi.act ? 'Mining' : 'Stopped');
          set('b8', el => { el.textContent = mi.act ? 'Stop Mining' : 'Start Mining'; el.className = mi.act ? 'btn btn-d btn-full' : 'btn btn-p btn-full'; });
          set('mbf', el => el.textContent = ms.blocks_found || 0);
          const hr = ms.hashrate || 0;
          set('mhr', el => el.textContent = hr >= 1000000 ? (hr / 1000000).toFixed(2) + ' MH/s' : hr >= 1000 ? (hr / 1000).toFixed(1) + ' KH/s' : hr.toFixed(0) + ' H/s');
          netStats.netHashrate = hr;
          const up = ms.uptime_seconds || 0;
          set('mut', el => el.textContent = up > 0 ? formatUptime(up) : '--');
          set('maddr', el => el.textContent = mi.act && w.a ? 'Mining to ' + w.a.slice(0, 16) + '...' : '');
          // Update difficulty from latest block (human-readable bits)
          const diff = ms.difficulty_bits || 0;
          set('mdiff', el => el.textContent = diff > 0 ? ('Difficulty: ' + diff + ' bits') : '--');
          // Update mining log
          if (mi.act && hr > 0) {
            const logEl = $('mlog');
            if (logEl) {
              const ts = new Date().toLocaleTimeString();
              const newLine = '[' + ts + '] Hash: ' + hr.toFixed(0) + ' H/s | Nonces: ' + (ms.nonces_total || 0);
              const lines = logEl.textContent.split('\n').slice(-9);
              lines.push(newLine);
              logEl.textContent = lines.join('\n');
              logEl.scrollTop = logEl.scrollHeight;
            }
          }
        }

        if (netHrRes.status === 'fulfilled') {
          const nh = netHrRes.value.hashrate || 0;
          set('ghr', el => el.textContent = nh >= 1000000 ? (nh / 1000000).toFixed(2) + 'M H/s' : nh >= 1000 ? (nh / 1000).toFixed(1) + 'K H/s' : nh.toFixed(0) + ' H/s');
          set('net-hashrate', el => el.textContent = nh >= 1000000 ? (nh / 1000000).toFixed(2) + 'M' : nh >= 1000 ? (nh / 1000).toFixed(1) + 'K' : nh.toFixed(0));
        }

        if (w.a) {
          // Fire wallet-specific calls in parallel
          const [balRes, rfRes, giRes, txRes, mpRes] = await Promise.allSettled([
            rpc('getbalance', [w.a]),
            rpc('getreferralinfo', [w.a]),
            rpc('getgovernanceinfo', [w.a]),
            rpc('gettransactionhistory', [w.a, 15]),
            rpc('getmempool', [])
          ]);
          if (balRes.status === 'fulfilled') { w.b = balRes.value.balance_knots || 0; }
          if (rfRes.status === 'fulfilled') {
            const rf = rfRes.value;
            r.c = rf.privacy_code || '';
            r.n = rf.total_referred_miners || 0;
            r.e = parseFloat(rf.total_referral_bonus_kot) || 0;
            // Update referral status indicator
            const hasReferred = (rf.total_referred_miners || 0) > 0;
            const isActive = rf.is_active_referrer === true;
            const hasMined = rf.referred_by !== undefined; // has mined if we have referral info
            set('refstatdot', el => {
              if (hasReferred && isActive) {
                el.style.background = '#4ade80';
              } else if (hasReferred && !isActive) {
                el.style.background = '#fbbf24';
              } else {
                el.style.background = '#666';
              }
            });
            set('refstattext', el => {
              if (hasReferred && isActive) {
                el.style.color = '#4ade80';
                el.textContent = 'Active Referrer — Your referrals will earn you 5% bonus';
              } else if (hasReferred && !isActive) {
                el.style.color = '#fbbf24';
                el.textContent = 'Referrer Inactive — Mine a block within last 48 hours to earn bonuses';
              } else if (hasMined) {
                el.style.color = '#888';
                el.textContent = 'No Referrals Yet — Share your referral link to earn 5% bonuses';
              } else {
                el.style.color = '#dc2626';
                el.textContent = 'Not Referred — You were not referred by anyone';
              }
            });
          }
          if (giRes.status === 'fulfilled') {
            const gi = giRes.value;
            set('gw', el => el.textContent = gi.governance_weight_bps ?? '--');
            set('gwp', el => el.textContent = gi.governance_weight_pct ?? '--');
            set('gcap', el => el.textContent = gi.cap_bps ?? '--');
            set('gstat', el => el.textContent = gi.is_capped ? 'CAPPED' : 'OK');
          }
          if (txRes.status === 'fulfilled') {
            const txlist = txRes.value.transactions || [];
            set('txhist', el => {
              if (!txlist.length) { el.textContent = 'No transactions yet'; return; }
              el.innerHTML = txlist.map(tx => {
                const cls = tx.type === 'sent' ? 'tx-sent' : tx.type === 'received' ? 'tx-recv' : 'tx-mine';
                const label = tx.type === 'sent' ? 'Sent' : tx.type === 'received' ? 'Received' : 'Mined';
                return '<div class="tx-row ' + cls + '"><span class="tx-type">' + label + '</span><span>' + tx.amount_kot + ' KOT</span><span style="color:#aaa">#' + tx.block_height + '</span></div>';
              }).join('');
            });
          }
          if (mpRes.status === 'fulfilled') {
            const mp = mpRes.value || [];
            set('mempool', el => {
              if (!mp.length) { el.textContent = 'No pending transactions'; return; }
              const rows = mp.slice(0, 10).map(t => {
                const amt = (t.amount_kot || '').toString();
                const fee = (t.fee_knots || 0).toString();
                const to = (t.recipient || '').toString();
                const from = (t.sender || '').toString();
                return '<div style="margin-bottom:4px">' + amt + ' KOT · fee ' + fee + ' · ' + from.slice(0,6) + '…' + from.slice(-4) + ' → ' + to.slice(0,6) + '…' + to.slice(-4) + '</div>';
              });
              el.innerHTML = rows.join('');
            });
          }
          maybeRegisterReferral();
        }

        await refreshBlocks();
        updateUI();
        $('dot').classList.add('on');
        $('status').textContent = 'Block ' + c.h + ' | ' + c.p + ' peers';
      } catch (e) {
        $('dot').classList.remove('on');
        $('status').textContent = 'Disconnected';
      }
      syncRunning = false;
    }

    function set(id, fn) { const el = $(id); if (el) fn(el); }

    async function refreshBlocks() {
      if (!$('blocks') || c.h === lastBlocksHeight) return;
      lastBlocksHeight = c.h;
      const start = Math.max(0, c.h - 9);
      const heights = [];
      for (let h = start; h <= c.h; h++)heights.push(h);
      const results = await Promise.allSettled(heights.map(async h => {
        const bh = await rpc('getblockhash', [h]);
        const b = await rpc('getblock', [bh]);
        const ts = b.time ? new Date(b.time * 1000).toLocaleTimeString() : '';
        const m = (b.miner || '').toString();
        const ms = m.length > 20 ? m.slice(0, 8) + '..' + m.slice(-6) : m;
        return { h: b.height, ts, tx: b.tx_count || 0, miner: ms };
      }));
      const rows = results.map((r, i) => {
        if (r.status === 'fulfilled') {
          const d = r.value;
          return '<div class="blk-row" data-height="' + d.h + '" style="cursor:pointer" title="Click to view details"><span class="blk-h">#' + d.h + '</span><span class="blk-ts">' + d.ts + '</span><span class="blk-tx">tx:' + d.tx + '</span><span class="blk-miner">' + d.miner + '</span></div>';
        }
        return '<div class="blk-row"><span class="blk-h">#' + heights[i] + '</span><span style="color:#dc2626">err</span></div>';
      });
      $('blocks').innerHTML = rows.reverse().join('');
      // Add click handlers to view block details
      $('blocks').querySelectorAll('.blk-row[data-height]').forEach(row => {
        row.addEventListener('click', () => {
          const h = row.getAttribute('data-height');
          showPage('network');
          $('blk-search').value = h;
          $('btn-blk-search').click();
        });
      });
    }

    function updateUI() {
      const kotBal = (w.b / K).toFixed(8);
      set('bal', el => el.textContent = kotBal);
      set('dashbal', el => el.textContent = parseFloat(kotBal).toFixed(2));
      set('sendbalpre', el => el.textContent = kotBal);
      set('addr', el => el.textContent = w.a || '--');
      set('recaddr', el => el.textContent = w.a || '--');
      set('h', el => el.textContent = c.h);
      set('p', el => el.textContent = c.p);
      set('m', el => el.textContent = c.mp);
      set('rlink', el => el.textContent = r.c ? 'knotcoin:?ref=' + r.c : '--');
      set('rc', el => el.textContent = r.n);
      set('re', el => el.textContent = r.e.toFixed(8));
      set('btime', el => el.textContent = 'Updated ' + new Date().toLocaleTimeString());
    }

    function show(id) {
      ['s0', 's1', 's2', 's3'].forEach(x => $(x).classList.remove('active'));
      $(id).classList.add('active');
      $('sidebar').style.display = (id === 's3') ? 'flex' : 'none';
    }

    function showPage(name) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      const pg = $('pg-' + name);
      if (pg) pg.classList.add('active');
      document.querySelectorAll('.nav-item').forEach(n => {
        n.classList.toggle('active', n.getAttribute('data-page') === name);
      });
      if (name === 'network') { stopNetMap(); setTimeout(startNetMap, 50); }
      else stopNetMap();
    }

    async function init() {
      // Setup button handlers FIRST so UI is always interactive
      setup();

      // Show correct screen immediately from localStorage
      const mn = localStorage.getItem('knotcoin_mnemonic');
      const ad = localStorage.getItem('knotcoin_address');
      if (mn && ad) { w.m = mn; w.a = ad; show('s3'); }
      else { show('s0'); }

      // Connect to RPC in background - don't block anything
      connectRpc();
    }

    async function connectRpc() {
      // Try to read auth token if Tauri context (legacy support)
      if (window.__TAURI__) {
        try {
          const inv = window.__TAURI__.core?.invoke || window.__TAURI__.invoke;
          if (inv) { for (let i = 0; i < 10; i++) { try { auth = await inv('get_rpc_auth_token'); if (auth) break; } catch (e) { } await new Promise(r => setTimeout(r, 500)); } }
        } catch (e) { }
      }
      if (!window.__TAURI__ && !auth) {
        auth = (localStorage.getItem('knotcoin_auth') || '').trim();
      }
      // Poll for RPC with visual feedback, don't freeze UI
      let att = 0;
      while (att < 60) {
        try {
          await rpc('getblockcount');
          if (w.a) startSync();
          return;
        } catch (e) {
          att++;
          $('status').textContent = 'Starting node… (' + att + '/60)';
          await new Promise(r => setTimeout(r, 1000));
        }
      }
      $('status').textContent = 'Node offline';
    }

    function setup() {
      // Onboarding: referral is on s0, collected BEFORE wallet creation
      $('b0').addEventListener('click', async () => {
        const rf = normalizeRefInput($('ref').value);
        if (rf) localStorage.setItem('knotcoin_referrer', rf);
        show('s1');
        try { const wl = await rpc('wallet_create'); $('newm').textContent = wl.mnemonic; temp = wl; }
        catch (e) {
          if (e.message && e.message.includes('already initialized')) {
            try { await rpc('wallet_reset'); const wl = await rpc('wallet_create'); $('newm').textContent = wl.mnemonic; temp = wl; }
            catch (e2) { alert('Error: ' + e2.message); show('s0'); }
          } else { alert('Error: ' + e.message); show('s0'); }
        }
      });
      $('b1').addEventListener('click', () => {
        const rf = normalizeRefInput($('ref').value);
        if (rf) localStorage.setItem('knotcoin_referrer', rf);
        show('s2');
      });
      $('b2').addEventListener('click', () => {
        if (!temp) return alert('No wallet generated');
        localStorage.setItem('knotcoin_mnemonic', temp.mnemonic);
        localStorage.setItem('knotcoin_address', temp.address);
        w.m = temp.mnemonic; w.a = temp.address; temp = null;
        show('s3'); startSync();
      });
      $('b3').addEventListener('click', () => show('s0'));
      $('b4').addEventListener('click', async () => {
        const mn = $('impm').value.trim();
        if (!mn) return alert('Enter mnemonic');
        try {
          const wl = await rpc('wallet_get_address', [mn]);
          localStorage.setItem('knotcoin_mnemonic', mn);
          localStorage.setItem('knotcoin_address', wl.address);
          w.m = mn; w.a = wl.address;
          show('s3'); startSync();
        } catch (e) { alert('Error: ' + e.message); }
      });
      $('b5').addEventListener('click', () => show('s0'));

      // Sidebar nav
      document.querySelectorAll('.nav-item').forEach(n => {
        n.addEventListener('click', () => showPage(n.getAttribute('data-page')));
      });

      // Send
      $('b6').addEventListener('click', async () => {
        const to = $('sendto').value.trim();
        const amt = parseFloat($('sendamt').value) || 0;
        if (!to || amt <= 0) return alert('Enter valid recipient and amount');
        const res = $('sendres'); res.classList.remove('hidden'); res.textContent = 'Sending...';
        try {
          if (!w.m) return alert('Wallet not loaded');
          const out = await rpc('wallet_send', [w.m, to, amt]);
          res.textContent = 'Sent. TXID: ' + (out.txid || '');
        } catch (e) { res.textContent = 'Error: ' + e.message; }
      });

      // Copy address
      $('b7').addEventListener('click', () => { if (w.a) { navigator.clipboard.writeText(w.a); $('b7').textContent = 'Copied!'; setTimeout(() => $('b7').textContent = 'Copy Address', 1500); } });
      $('addr').addEventListener('click', () => { if (w.a) navigator.clipboard.writeText(w.a); });
      $('recaddr').addEventListener('click', () => { if (w.a) navigator.clipboard.writeText(w.a); });
      $('rlink').addEventListener('click', () => { const t = $('rlink').textContent; if (t && t !== '--') navigator.clipboard.writeText(t); });

      // Mining
      $('b8').addEventListener('click', async () => {
        if (mi.act) {
          await rpc('stop_mining'); mi.act = false;
          $('b8').textContent = 'Start Mining'; $('b8').className = 'btn btn-p btn-full';
          $('mdot').classList.remove('on'); $('mtext').textContent = 'Stopped';
        } else {
          await maybeRegisterReferral();
          const threads = parseInt($('mthreads').value) || 4;
          mi.threads = Math.max(1, Math.min(8, threads));
          if (!confirm('Start mining with ' + mi.threads + ' thread(s)?')) return;
          const rf = localStorage.getItem('knotcoin_referrer');
          if (rf && w.a && rf.toUpperCase().startsWith('KOT') && rf.replace(/^KOT1?/i, '') === w.a.replace(/^KOT1?/i, '')) {
            return alert('Self-referral is not permitted');
          }
          const args = rf ? [w.m, mi.threads, rf] : [w.m, mi.threads];
          await rpc('start_mining', args); mi.act = true;
          $('b8').textContent = 'Stop Mining'; $('b8').className = 'btn btn-d btn-full';
          $('mdot').classList.add('on'); $('mtext').textContent = 'Mining (' + mi.threads + ' threads)';
        }
      });

      // Governance
      $('bgovsend').addEventListener('click', async () => {
        const hex = $('ghex').value.trim();
        if (!hex || hex.length !== 64) return alert('Enter 64 hex chars');
        const res = $('govsendres'); res.classList.remove('hidden'); res.textContent = 'Sending...';
        try { if (!w.m) return alert('Wallet not loaded'); const out = await rpc('wallet_send', [w.m, w.a, 0, hex]); res.textContent = 'Signal sent. TXID: ' + (out.txid || ''); }
        catch (e) { res.textContent = 'Error: ' + e.message; }
      });
      $('bgovtally').addEventListener('click', async () => {
        const hex = $('gtally').value.trim();
        if (!hex || hex.length !== 64) return alert('Enter 64 hex chars');
        const res = $('govtallyres'); res.classList.remove('hidden'); res.textContent = 'Loading...';
        try { const out = await rpc('getgovernancetally', [hex]); res.textContent = 'Weight: ' + (out.total_weight_pct || '0%') + ' | Passed: ' + (out.is_passed ? 'YES' : 'NO'); }
        catch (e) { res.textContent = 'Error: ' + e.message; }
      });

      // Block Search
      $('btn-blk-search').addEventListener('click', async () => {
        const h = parseInt($('blk-search').value);
        if (!h || h < 1) return alert('Enter valid block height');
        try {
          const blk = await rpc('getblockbyheight', [h]);
          $('blk-result').classList.remove('hidden');
          $('blk-h').textContent = blk.height;
          $('blk-hash').textContent = blk.hash;
          $('blk-miner').textContent = blk.miner;
          $('blk-reward').textContent = blk.reward_kot;
          // Format difficulty as readable number
          const diffBits = blk.difficulty_bits || 0;
          $('blk-diff').textContent = diffBits + ' bits';
          $('blk-time').textContent = new Date(blk.time * 1000).toLocaleString();
          $('blk-txs').textContent = blk.tx_count;
          $('blk-prev').textContent = blk.previousblockhash.slice(0, 32) + '...';
        } catch (e) { alert('Block not found: ' + e.message); }
      });
      $('blk-search').addEventListener('keypress', e => { if (e.key === 'Enter') $('btn-blk-search').click(); });
      $('blk-close').addEventListener('click', () => $('blk-result').classList.add('hidden'));

      // Settings
      $('b9').addEventListener('click', () => {
        const box = $('mrev');
        if (box.classList.contains('hidden')) { box.textContent = w.m || 'Not found'; box.classList.remove('hidden'); }
        else { box.classList.add('hidden'); }
      });
      // Governance: generate proposal hash from text
      $('bgovhash').addEventListener('click', async () => {
        const txt = ($('gtext').value || '').trim();
        if (!txt) return alert('Enter proposal text');
        try {
          const enc = new TextEncoder().encode(txt);
          const digest = await crypto.subtle.digest('SHA-256', enc);
          const hex = Array.from(new Uint8Array(digest)).map(b => b.toString(16).padStart(2, '0')).join('');
          $('ghex').value = hex;
          $('gtally').value = hex;
          const box = $('govhashres');
          box.textContent = 'Proposal hash: ' + hex;
          box.classList.remove('hidden');
        } catch (e) {
          alert('Hash failed: ' + (e.message || e));
        }
      });
      $('b10').addEventListener('click', async () => {
        if (!confirm('DELETE WALLET?\n\nBackup your mnemonic first.')) return;
        if (!confirm('FINAL WARNING. Click OK to delete.')) return;
        try {
          await rpc('wallet_reset');
          if (timer) clearInterval(timer);
          localStorage.clear(); w = { m: null, a: null, b: 0 };
          setTimeout(() => location.reload(), 300);
        } catch (e) { alert('Reset failed: ' + e.message); }
      });
    }

    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
    else init();
  </script>
</body>

</html>
